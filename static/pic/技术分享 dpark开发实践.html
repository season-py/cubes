<!DOCTYPE html>
<!-- saved from url=(0107)http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5 -->
<html xmlns="http://www.w3.org/1999/xhtml"><!--
  Licensed to the Apache Software Foundation (ASF) under one
  or more contributor license agreements.  See the NOTICE file
  distributed with this work for additional information
  regarding copyright ownership.  The ASF licenses this file
  to you under the Apache License, Version 2.0 (the
  "License"); you may not use this file except in compliance
  with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing,
  software distributed under the License is distributed on an
  "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  KIND, either express or implied.  See the License for the
  specific language governing permissions and limitations
  under the License.
--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="./技术分享 dpark开发实践_files/bootstrap.css" type="text/css">
    <link rel="stylesheet" href="./技术分享 dpark开发实践_files/bootstrap-responsive.css" type="text/css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
      技术分享/dpark开发实践 – 17173数据组
    </title>
    <!--[if lt IE 7]>
    <script type="text/javascript" src="/main/chrome/common/js/ie_pre7_hacks.js"></script>
    <![endif]-->
    <meta http-equiv="X-UA-Compatible" content="IE=edge"><link rel="search" href="http://10.5.17.222/main/search"><link rel="help" href="http://10.5.17.222/main/wiki/Guide/Index"><link rel="alternate" href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5?format=txt" type="text/x-trac-wiki" title="纯文本"><link rel="alternate" href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5?format=slideshow" type="text/x-trac-wiki" title="Slideshow"><link rel="alternate" href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5?format=pdfarticle" type="text/x-trac-wiki" title="PDF Article"><link rel="alternate" href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5?format=pdfbook" type="text/x-trac-wiki" title="PDF Book"><link rel="alternate" href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5?format=printhtml" type="text/x-trac-wiki" title="Printable HTML"><link rel="up" href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB" title="查看父页面"><link rel="start" href="http://10.5.17.222/main/wiki"><link rel="stylesheet" href="./技术分享 dpark开发实践_files/wysiwyg.css" type="text/css"><link rel="stylesheet" href="./技术分享 dpark开发实践_files/ui.theme.css" type="text/css"><link rel="stylesheet" href="./技术分享 dpark开发实践_files/ui.resizable.css" type="text/css"><link rel="stylesheet" href="./技术分享 dpark开发实践_files/bloodhound.css" type="text/css"><link rel="tracwysiwyg.stylesheet" href="http://10.5.17.222/main/chrome/common/css/trac.css"><link rel="tracwysiwyg.stylesheet" href="http://10.5.17.222/main/chrome/tracwysiwyg/editor.css"><link rel="tracwysiwyg.base" href="http://10.5.17.222/main"><link rel="shortcut icon" href="http://10.5.17.222/main/chrome/theme/img/bh.ico" type="image/x-icon"><link rel="icon" href="http://10.5.17.222/main/chrome/theme/img/bh.ico" type="image/x-icon"><link type="application/opensearchdescription+xml" rel="search" href="http://10.5.17.222/main/search/opensearch" title="搜索 17173数据组"><script type="text/javascript" charset="utf-8" src="./技术分享 dpark开发实践_files/jquery.js"></script><script type="text/javascript" charset="utf-8" src="./技术分享 dpark开发实践_files/babel.js"></script><script type="text/javascript" charset="utf-8" src="./技术分享 dpark开发实践_files/zh_CN.js"></script><script type="text/javascript" charset="utf-8" src="./技术分享 dpark开发实践_files/trac.js"></script><script type="text/javascript" charset="utf-8" src="./技术分享 dpark开发实践_files/search.js"></script><script type="text/javascript" charset="utf-8" src="./技术分享 dpark开发实践_files/folding.js"></script><script type="text/javascript" charset="utf-8" src="./技术分享 dpark开发实践_files/wysiwyg.js"></script><script type="text/javascript" charset="utf-8" src="./技术分享 dpark开发实践_files/wysiwyg-load.js"></script><script type="text/javascript" charset="utf-8" src="./技术分享 dpark开发实践_files/tools.flashembed-1.0.4.min.js"></script><script type="text/javascript" charset="utf-8" src="./技术分享 dpark开发实践_files/mindmap.js"></script><script type="text/javascript" charset="utf-8" src="./技术分享 dpark开发实践_files/ui.core.js"></script><script type="text/javascript" charset="utf-8" src="./技术分享 dpark开发实践_files/ui.resizable.js"></script><link rel="alternate" type="application/x-wiki" href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5?action=edit" title="编辑此页面"><script type="text/javascript">
      jQuery(document).ready(function($) {
        $("#content").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $("#content").find(".wikianchor").each(function() {
          $(this).addAnchor(babel.format(_("Link to #%(id)s"), {id: $(this).attr('id')}));
        });
        $(".foldable").enableFolding(true, true);
      });
    </script>
    <script src="./技术分享 dpark开发实践_files/theme.js" type="text/javascript"></script>
    <script src="./技术分享 dpark开发实践_files/bootstrap.js" type="text/javascript"></script>
  <style type="text/css"></style></head>
  <body>
    <div class="container">
      <header>
        <div class="row">
          <div id="logo" class="span4">
            <p>
              <a href="http://10.5.17.222/main">
                <img src="./技术分享 dpark开发实践_files/bh_logo.png" alt="Bloodhound Logo">
              </a>
            </p>
          </div>
            <div id="usermenu" class="span8">
              <div class="metanav pull-right">
                <span id="nav_login">
                    <i class="icon-user"></i>haishanzhang
                </span>
                <span id="nav_logout">
                  <a href="http://10.5.17.222/main/logout">注销</a>
                </span>
                <span>
                  <a href="http://10.5.17.222/main/prefs">个人设置</a>
                </span>
                <span>
                  <a href="http://10.5.17.222/main/wiki/Guide/Index">帮助/指南</a>
                </span>
              </div>
            </div>
        </div>
        <div class="row">
          <div class="span6">
            <div id="searchbox" class="btn-toolbar">
              <div class="btn-group">
                <form id="mainsearch" class="form-inline" action="http://10.5.17.222/main/search" method="get">
                  <div class="input-append">
                    <input type="text" class="span3" id="q" name="q" placeholder="Search anything. Try #EF-492.">
                    <button type="submit" class="btn btn-warning">
                      <span class="hidden-phone hidden-tablet">搜索</span>
                      <i class="icon-search icon-white"></i>
                    </button>
                  </div>
                </form>
              </div>
              <div class="btn-group">
                    <a href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5#" class="btn btn-primary dropdown-toggle" id="qct-newticket" data-animation="true" data-html="true" data-trigger="manual" data-toggle="dropdown" data-original-title="" title="">
                      <span class="visible-phone"><i class="icon-plus-sign icon-white"></i></span>
                      <span class="hidden-phone">Create Ticket</span>
                    </a>
                    <div id="qct-box" class="dropdown-menu" style="width: 300px;">
                      <div class="popover-title">
                        <h3>
                          Create Ticket
                          <a style="top: -33px; right: -25px; position: relative;" class="pull-right" href="http://10.5.17.222/main/newticket">
                            <small>Full dialogue »</small>
                          </a>
                        </h3>
                      </div>
                      <div class="popover-content">
                          <form id="qct-form" name="qct" method="post"><div><input type="hidden" name="__FORM_TOKEN" value="0f4e4783c258c1de584673ff"></div>
                            <div id="qct-fieldset">
                <div>
                  <label for="field-summary">概述</label>
                  <input type="text" id="field-summary" name="field_summary" placeholder="Ticket summary">
                </div>
                <div>
                  <label for="field-description">描述</label>
                  <textarea id="field-description" name="field_description" rows="3" cols="28" placeholder="Ticket description"></textarea>
                </div>
                <div class="form-horizontal">
                    <label class="control-label" for="field-product">Product</label>
                    <div class="controls">
                  <select id="field-product" name="field_product" class="input-medium" data-empty="true" data-field="product">
                    <option></option>
                    <option value="logstat">logstat</option><option value="流量统计">流量统计</option><option value="日常任务">日常任务</option><option value="计划外任务">计划外任务</option><option value="打酱游">打酱游</option>
                  </select>
                    </div>
                    <label class="control-label" for="field-version">版本</label>
                    <div class="controls">
                  <select id="field-version" name="field_version" class="input-medium" data-empty="true" data-field="version">
                    <option></option>
                    <option value="2.0">2.0</option><option value="1.0">1.0</option><option value="3.5">3.5</option><option value="3.0">3.0</option>
                  </select>
                    </div>
                    <label class="control-label" for="field-type">类型</label>
                    <div class="controls">
                  <select id="field-type" name="field_type" class="input-medium" data-empty="true" data-field="type">
                    <option value="Bug">Bug</option><option value="增强">增强</option><option value="任务">任务</option>
                  </select>
                    </div>
                </div>
                            </div>
                          </form>
                          <button id="qct-create" class="btn" data-target="/main">创建</button>
                          <a id="qct-cancel">取消</a>
                      </div>
                    </div>
              </div>
            </div>
          </div>
          <div class="span6">
            <ul class="nav nav-tabs pull-right" id="mainnav">
              <li class="first active"><a href="http://10.5.17.222/main/wiki">Wiki</a></li><li><a href="http://10.5.17.222/main/dashboard">任务单</a></li>
              <li class="dropdown">
                <a class="dropdown-toggle" data-toggle="dropdown" href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5#">Apps<b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li class="first"><a href="http://10.5.17.222/main/newticket">新建任务单</a></li><li><a href="http://10.5.17.222/main/products">Products</a></li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
        <div class="row" id="breadcrumb-row">
          <div id="stickyStatus" class="span12">
            <ul class="breadcrumb">
              <li>
                
  </li><li>
    <a title="View default wiki page" href="http://10.5.17.222/main/wiki">wiki</a>
  </li>
  <li>
    <a href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB" title="查看 技术分享">技术分享</a>
    <span class="divider">/</span>
  </li><li>
    <a href="./技术分享 dpark开发实践_files/技术分享 dpark开发实践.html" title="查看 技术分享/dpark开发实践">dpark开发实践</a>
  </li>

              
              <li class="pull-right hidden-phone">
                  <a href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB">向上</a>
                  &nbsp;&nbsp;&nbsp;&nbsp;
                  <a href="http://10.5.17.222/main/wiki/WikiStart">起始页</a>
                  &nbsp;&nbsp;&nbsp;&nbsp;
                  <a href="http://10.5.17.222/main/wiki/TitleIndex">索引</a>
                  &nbsp;&nbsp;&nbsp;&nbsp;
                  <a href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5?action=history">历史</a>
              </li>
            </ul>
          </div>
        </div>
        <div class="row">
          <!-- div id="alert-log" class="dropdown-menu" style="display: none">
            <div class="popover-title">
              <button id="alert-log-close" data-dismiss="alert" 
                  class="close">&times;</button>
              <h3 id="alert-log-title"></h3>
            </div>
            <div class="popover-content">
              <div id="alert-msg"></div>
              <ul id="alert-links" class="nav"></ul>
            </div>
          </div -->
        </div>
      </header>
      <div class="stickyOffset" style="height: 0px;"></div>
    <div id="content" class="wiki row">
      <div class="wikipage searchable span12">
        
          
          <div class="trac-modifiedby">
            <span><a href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5?action=diff&version=49" title="由 zhangmingyuan 编辑的 49: fix image path">Last modified</a> <a class="timeline" href="http://10.5.17.222/main/timeline?from=2014-08-01T11%3A42%3A05%2B08%3A00&precision=second" title="See timeline at 2014-8-1 上午11:42:05">10天 ago</a></span>
            <span class="trac-print">Last modified on 2014-8-1 上午11:42:05</span>
          </div>
          <div id="wikipage"><h1 id="Dpark开发实践"><strong>Dpark 开发实践</strong><a class="anchor" href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5#Dpark开发实践" title="链接到这一节"> ¶</a></h1>
<h2 id="a1.RDD概念">1. <strong>RDD 概念</strong><a class="anchor" href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5#a1.RDD概念" title="链接到这一节"> ¶</a></h2>
<ul><li>Resilient Distributed Datasets 弹性分布式数据集
</li><li>只读的，是一种分布式的内存抽象，允许在集群上执行基于内存的计算（In-Memory Computing）
</li><li>rdd的数据必须可被序列化（marshal、pickle、cPickle）
</li><li>内存不足时会spill到硬盘
</li><li>Dpark数据并行（data parallel）的计算范式决定了rdd是一种粗粒度的数据集合（计算的主体不是个别数据），性能更好
</li><li>集合内的所有数据都经过同样的算子序列
</li><li>所有算子都是幂等的（s*s = s），出现错误是只需把算子序列重新执行一遍即可
</li><li>rdd含有如何从其它rdd衍生出本rdd的相关信息（rdd对象中的dependencies属性即保存该rdd的血统（lineage）信息）
</li><li>rdd的几个重要属性
<ul><li>dependencies - 依赖关系
</li><li>splits - 分片列表，有分片才有并行化
</li><li>compute - 计算函数，计算每个分片
</li><li>preferredLocations - 分片的优先计算位置
</li><li>partitioner - key-value型的rdd是根据哈希来分区的，控制key分到哪个reduce
</li></ul></li></ul><h2 id="a2.算子概念">2. <strong>算子概念</strong><a class="anchor" href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5#a2.算子概念" title="链接到这一节"> ¶</a></h2>
<ul><li>一个函数空间到另一个函数空间（或它自身）的映射
</li><li>在dpark中即指rdd的基础运算函数
</li><li>分为两类：transformation 和 action
<ul><li>transformation 转换，如map、filter、groupBy、join等，惰性的，用于定义一个新的rdd，并不立即执行
</li><li>action 行为，如count，collect，saveAsTextFile等，触发runJob，启动计算，并向用户程序返回值或向外部存储写数据
</li></ul></li></ul><h2 id="a3.算子举例">3. 算子举例<a class="anchor" href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5#a3.算子举例" title="链接到这一节"> ¶</a></h2>
<ul><li>transformation
<ul><li>map(func)
<ul><li>生成新的rdd，每个元素经过func函数转换
</li><li>
<pre class="wiki">Fields = ['log_d_str', 'log_dt_str', 'userid', 'game_type', 'game_name']

# 初始Rdd
SrcRdd = dpark.textFile('../warehouse/UserPrizeTaking/prizetaking-20140720')

# map转换函数
def map_func(line):
    return dict(zip(Fields, line.strip('\n').split('\t')))

# 经过map转换，生成新的Rdd
MappedRdd = SrcRdd.map(map_func)
</pre></li><li>
<pre class="wiki">2014-07-20      2014-07-20 01:09:44     309349976@qq.com        1       天龙八部
2014-07-20      2014-07-20 08:42:11     37793080@qq.com         1       斗仙

{'game_name': '天龙八部',
 'game_type': '1',
 'log_d_str': '2014-07-20',
 'log_dt_str': '2014-07-20 01:09:44',
 'userid': '309349976@qq.com'}
{'game_name': '斗仙',
 'game_type': '1',
 'log_d_str': '2014-07-20',
 'log_dt_str': '2014-07-20 08:42:11',
 'userid': '37793080@qq.com'}
</pre></li></ul></li><li>filter(func)
<ul><li>生成新的rdd，由经过func处理后返回值为真的元素组成
</li><li>
<pre class="wiki"># 过滤函数
def filter_func(line):
    if line['game_name'] == '天龙八部':
        return line
        
# 经过filter过滤，生成新的Rdd
FilteredRdd = MappedRdd.filter(filter_func)
</pre></li><li>
<pre class="wiki">{'game_name': '天龙八部',
 'game_type': '1',
 'log_d_str': '2014-07-20',
 'log_dt_str': '2014-07-20 01:09:44',
 'userid': '309349976@qq.com'}
{'game_name': '天龙八部',
 'game_type': '1',
 'log_d_str': '2014-07-20',
 'log_dt_str': '2014-07-20 19:23:11',
 'userid': 'wq100105807@17173.com'}
</pre></li></ul></li><li>flatMap(func)
<ul><li>类似于map，但是每一个输入元素，会被映射为0到多个输出元素（因此，func函数的返回值是一个Seq，而不是单一元素）
</li><li>
<pre class="wiki"># flatmap转换函数
def flatmap_func(line):
    return line, line

# 经过flatmap转换后的Rdd
FlattedRdd = FilteredRdd.flatMap(flatmap_func)
</pre></li><li>
<pre class="wiki">2014-07-20      2014-07-20 01:09:44     309349976@qq.com        1       天龙八部

{'game_type': '1', 'userid': '309349976@qq.com', 'game_name': '天龙八部', 'log_d_str': '2014-07-20', 'log_dt_str': '2014-07-20 01:09:44'}
{'game_type': '1', 'userid': '309349976@qq.com', 'game_name': '天龙八部', 'log_d_str': '2014-07-20', 'log_dt_str': '2014-07-20 01:09:44'}
</pre></li></ul></li><li>union(otherDataSet)
<ul><li>生成新的rdd，由原rdd和参数otherDataSet联合而成
</li><li>
<pre class="wiki">OtherRdd = dpark.textFile('../warehouse/MacInsUnins/2014-07-21/0000')
# 联合列表中的Rdd，生成一个合集
UnionRdd = dpark.union([SrcRdd, OtherRdd])
</pre></li><li>
<pre class="wiki">2014-07-20      2014-07-20 22:37:25     pl71620@17173.com       2       卧龙
2014-07-21      2014-07-21 23:39:57     qq_131379002@17173.com  1       自由足球
</pre></li></ul></li><li>groupByKey
<ul><li>在一个由 （K, V） 对组成的数据集上调用，返回一个（K，Seq[V]） 对的数据集。注意：默认情况下，使用numSplits个并行任务进行分组，你可以传入numSplits可选参数，根据数据量设置不同数目的Split
</li><li>
<pre class="wiki">GroupRdd = UnionRdd.map(map_func).map(
    lambda row: (row['userid'], row['game_name'])).groupByKey()
</pre></li><li>
<pre class="wiki">('cykangta@17173.com', ['TERA'])
('1050279192@qq.com', ['天龙八部', '斗仙'])
</pre></li></ul></li><li>reduceByKey
<ul><li>在一个（K，V）对的数据集上使用，返回一个（K，V）对的数据集，key相同的值，都被使用指定的reduce函数聚合到一起。和groupbykey类似，任务的个数是可以通过第二个可选参数来配置的
</li><li>
<pre class="wiki"># reduce函数
def reduce_func(x, y):
    return x + y

# 对userid进行计数
ReduceRdd = UnionRdd.map(map_func).map(
    lambda row: (row['userid'], 1)).reduceByKey(reduce_func)
</pre></li><li>
<pre class="wiki">('cykangta@17173.com', 1)
('1050279192@qq.com', 1)
('likeakfm@qq.com', 5)
</pre></li></ul></li><li>join
<ul><li>在类型为（K,V)和（K,W)类型的数据集上调用，返回一个（K,(V,W))对，相同的key中的所有元素都被聚集在一起
</li><li>
<pre class="wiki"># 内联操作，以用户id为key，日期为value，将同一用户的登录日期聚合在一起
JoinRdd = SrcRdd.map(map_func).map(
    lambda row: (row['userid'], row['log_d_str'])).join(
        OtherRdd.map(map_func).map(
            lambda row: (row['userid'], row['log_d_str'])))
</pre></li><li>
<pre class="wiki">('wfc003@163.com', ('2014-07-20', '2014-07-21'))
</pre></li></ul></li><li>leftOuterJoin
<ul><li>同Join，但左边的数据集(k, v)在右边的数据集中无相同的key匹配时，返回(k, (v, None))
</li><li>
<pre class="wiki">LeftJoinRdd = SrcRdd.map(map_func).map(
    lambda row: (row['userid'], row['log_d_str'])).leftOuterJoin(
        OtherRdd.map(map_func).map(
            lambda row: (row['userid'], row['log_d_str'])))
</pre></li><li>
<pre class="wiki">('969090914@17173.com', ('2014-07-20', None))
('wfc003@163.com', ('2014-07-20', '2014-07-21'))
</pre></li></ul></li><li>rightOuterJoin
<ul><li>同Join，但右边的数据集(k, v)在右边的数据集中无相同的key匹配时，返回(k, (None, v))
</li><li>
<pre class="wiki">RightJoinRdd = SrcRdd.map(map_func).map(
    lambda row: (row['userid'], row['log_d_str'])).rightOuterJoin(
        OtherRdd.map(map_func).map(
            lambda row: (row['userid'], row['log_d_str'])))
</pre></li><li>
<pre class="wiki">('cathrynlef7@17173.com', (None, '2014-07-21'))
('wfc003@163.com', ('2014-07-20', '2014-07-21'))
</pre></li></ul></li><li>reduce
<ul><li>通过函数func聚集数据集中的所有元素。func函数接受2个参数，返回一个值
</li></ul></li><li>uniq
<ul><li>对数据集去重，dpark中的uniq是通过reduceByKey实现的
</li><li>
<pre class="wiki"># 剔重操作，剔重对象必须可hash
UniqRdd = UnionRdd.map(map_func).map(
    lambda row: row['userid']).uniq()
</pre></li><li>
<pre class="wiki">cykangta@17173.com
1050279192@qq.com
likeakfm@qq.com
cathrynlef7@17173.com
14994224891@17173.com
</pre></li></ul></li></ul></li><li>action
<ul><li>collect
<ul><li>以数组的形式，返回数据集的所有元素
</li><li>
<pre class="wiki"># 剔重操作，剔重对象必须可hash
UniqRdd = UnionRdd.map(map_func).map(
    lambda row: row['userid']).uniq()

for item in UniqRdd.collect():
	print item
</pre></li><li>
<pre class="wiki">duanyi5789@qq.com
doubiqiangshen@17173.com
qq_139418068@17173.com
df1384602916145@17173.com
zyc9711908@17173.com
suwenxin2000@17173.com
</pre></li></ul></li><li>count
<ul><li>返回数据集的元素个数
</li><li>
<pre class="wiki"># 剔重操作，剔重对象必须可hash
UniqRdd = UnionRdd.map(map_func).map(
    lambda row: row['userid']).uniq()

print UniqRdd.count()
</pre></li><li>
<pre class="wiki">2094
</pre></li></ul></li><li>take
<ul><li>返回一个数组，由数据集的前n个元素组成。注意，这个操作目前并非在多个节点上并行执行，而是Driver程序所在机器，单机计算所有的元素
</li><li>
<pre class="wiki"># 剔重操作，剔重对象必须可hash
UniqRdd = UnionRdd.map(map_func).map(
    lambda row: row['userid']).uniq()

for item in UniqRdd.take(2):
    print item
</pre></li><li>
<pre class="wiki">cykangta@17173.com
1050279192@qq.com
</pre></li></ul></li><li>first
<ul><li>返回数据集的第一个元素（类似于take（1））
</li><li>
<pre class="wiki"># 剔重操作，剔重对象必须可hash
UniqRdd = UnionRdd.map(map_func).map(
    lambda row: row['userid']).uniq()

print UniqRdd.first()
</pre></li><li>
<pre class="wiki">cykangta@17173.com
</pre></li></ul></li><li>saveAsTextFile
<ul><li>将数据集的元素以textfile的形式保存到本地文件系统，支持文件压缩
</li></ul></li><li>foreach
<ul><li>在数据集的每一个元素上，运行函数func。这通常用于更新一个累加器变量，或者和外部存储系统做交互，func函数无返回值
</li></ul></li></ul></li></ul><h2 id="a4.Job概念">4. Job 概念<a class="anchor" href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5#a4.Job概念" title="链接到这一节"> ¶</a></h2>
<ul><li>用户提交的作业，执行action操作时，用户就向集群提交了一个作业
</li></ul><h2 id="a5.Stage概念">5. Stage 概念<a class="anchor" href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5#a5.Stage概念" title="链接到这一节"> ¶</a></h2>
<ul><li>用户的job被提交给DAGScheduler
</li><li>stage产生过程
<ul><li>提交的job会先生成一个final Stage
</li><li>获取final Stage的rdd的依赖关系，对于窄依赖，不产生新的Stage，对于宽依赖，会产生一个新的map Stage作为parent Stage
</li><li>Stage DAG产生后，针对每个Stage生成相应的task，提交给调度器（TaskScheduler）执行
</li></ul></li></ul><h2 id="a6.DAG概念">6. DAG 概念<a class="anchor" href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5#a6.DAG概念" title="链接到这一节"> ¶</a></h2>
<ul><li>Directed Acyclic Graph 有向无环图
</li><li>根据rdd依赖关系的不同，Dpark也将每一个job分为不同的stage，而stage之间的依赖关系则形成了DAG
</li><li>dependency - 依赖
<ul><li>narrow dependency - 窄依赖，父RDD的每一个分区最多被一个子RDD的分区所用（map、flatMap、glom、filter等都属于窄依赖）
</li><li>wide dependency （shuffle dependency）- 宽依赖，子RDD的分区依赖于父RDD的所有分区（reduceByKey、sort、combineByKey、uniq等属于宽依赖）
<ul><li><a style="padding:0; border:none" href="http://10.5.17.222/main/attachment/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5/dependency.png"><img src="./技术分享 dpark开发实践_files/dependency.png"></a>
</li></ul></li><li>narrow dependency对于数据的重算开销要远小于wide Dependency的数据重算开销
</li><li>对于narrow dependency，内部执行流水线（pipeline）优化
</li><li>观察stage的生成过程：修改schedule.py中DAGScheduler的日志打印级别为info
<ul><li>
<pre class="wiki">RightJoinRdd = SrcRdd.map(map_func).map(
    lambda row: (row['userid'], row['log_d_str'])).rightOuterJoin(
        OtherRdd.map(map_func).map(
            lambda row: (row['userid'], row['log_d_str'])))

for item in RightJoinRdd.take(10):
    print item
</pre></li><li>
<pre class="wiki">2014-07-31 09:43:23,865 [INFO] [scheduler] new stage: &lt;Stage(1) for &lt;MappedRDD &lt;MappedRDD &lt;TextFileRDD /mfs/product/bigdipper/warehouse/UserPrizeTaking/prizetaking-20140720&gt;&gt;&gt;&gt;
2014-07-31 09:43:23,865 [INFO] [scheduler] new stage: &lt;Stage(2) for &lt;MappedRDD &lt;MappedRDD &lt;TextFileRDD /mfs/product/bigdipper/warehouse/UserPrizeTaking/prizetaking-20140721&gt;&gt;&gt;&gt;
2014-07-31 09:43:23,865 [INFO] [scheduler] new stage: &lt;Stage(3) for &lt;FlatMappedRDD &lt;CoGrouped of &lt;MappedRDD &lt;MappedRDD &lt;TextFileRDD /mfs/product/bigdipper/warehous&gt;&gt;
</pre></li></ul></li></ul></li></ul><h2 id="a7.Task概念">7. Task 概念<a class="anchor" href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5#a7.Task概念" title="链接到这一节"> ¶</a></h2>
<ul><li>Task是介于DAGScheduler和!TaskScheduler中间的接口
</li><li>被传送给executor执行的工作单元
</li><li>task数即为rdd的分片数
</li></ul><h2 id="a8.开发案例">8. 开发案例<a class="anchor" href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5#a8.开发案例" title="链接到这一节"> ¶</a></h2>
<ul><li>以北斗v2.5为例，代码地址http://code.data.17173.com/bigdipper
</li><li>代码结构 *
<pre class="wiki">.
├── daily_task.py                           --    每日调度任务
├── indicator                                  --    指标模块（一个指标对应一个py文件）
│&nbsp;&nbsp; ├── __init__.py
│&nbsp;&nbsp; ├── mac_core.py
│&nbsp;&nbsp; ├── mac_dau.py
│&nbsp;&nbsp; └── mac_trans_matrix.py
├── __init__.py
├── logstore                                   --     日志管理模块（一种日志对应一个py文件，定义了解析方法，以及封装了一些rdd相关的类）
│&nbsp;&nbsp; ├── __init__.py
│&nbsp;&nbsp; ├── mac_ins_unins.py
│&nbsp;&nbsp; ├── mac_new_coming.py
│&nbsp;&nbsp; ├── mac_raw_activity.py
│&nbsp;&nbsp; ├── mac_session.py
│&nbsp;&nbsp; ├── mac_status.py
│&nbsp;&nbsp; ├── user_game_following.py
│&nbsp;&nbsp; └── user_registration.py
├── models                                     --     orm（对象关系映射，采用ponyorm，自动建表，自动类型检查，自动生成表索引）
│&nbsp;&nbsp; ├── __init__.py
│&nbsp;&nbsp; └── model.py
├── settings.py                              --       配置文件，工作路径、指标模块路径、日志模块路径、数据库连接参数等
├── task.lock                                   --      文件锁，防止重复调度
├── task.py                                      --      celery调度文件 
└── usavich                                     --      公共库
    ├── common
    ├── dbconn                                --       数据库连接模块
    │&nbsp;&nbsp; ├── cxoradb.py
    │&nbsp;&nbsp; ├── __init__.py
    │&nbsp;&nbsp; ├── iredis.py
    │&nbsp;&nbsp; ├── itorndb.py
    │&nbsp;&nbsp; └── mongodb.py
    ├── etl
    ├── indicator                              --       基础的指标模块，以及封装了一些简便的指标模型
    │&nbsp;&nbsp; ├── base.py
    │&nbsp;&nbsp; ├── coindicator.py
    │&nbsp;&nbsp; └── __init__.py
    ├── __init__.py
    ├── logstore                                --      基础的日志模块
    │&nbsp;&nbsp; ├── base.py
    │&nbsp;&nbsp; └── __init__.py
    ├── pyoozie                                 --      oozie调度api（开源项目，做了一些修改）
    │&nbsp;&nbsp; ├── errors.py
    │&nbsp;&nbsp; ├── __init__.py
    │&nbsp;&nbsp; ├── oozie.py
    │&nbsp;&nbsp; └── utils.py
    └── utils                                         --     工具库（包含时间解析、一些日志和指标的装饰器、日志存储等）
        ├── deco.py
        ├── dtparser.py
        ├── dump.py
        ├── __init__.py
        └── ooziejob.py

</pre></li><li>添加一个指标，以安装设备量为例，继承usavich.indicator.base.Base，实现compute方法
<pre class="wiki"># coding=utf-8
# author=season
from usavich.indicator.coindicator import CoIndicator
from usavich.utils.deco import indsetdecorator
from usavich.indicator.base import Base


@indsetdecorator
class MacIns(Base):

    """安装设备"""

    goal = 'mac'

    # 具体的计算方法
    def compute(self):
        key = self.key  # 传入的维度参数
        goal = self.goal  # 度量值
        extend = self.extend  # 传入的维度扩展方法
        ins_rdd = self.context.parsed_rdd('MacInsUnins')  # 解析后的安装日志rdd
        co_ins_rdd = CoIndicator(rdd=ins_rdd)  # rdd的拓展类型
        co_uv = co_ins_rdd.uv_by_flat_key(key, goal, extend, numSplits=128)  # 对mac进行相应维度的剔重操作
        return co_uv  # 返回最终rdd

</pre></li></ul><ul><li>添加一种日志类型，以浏览器访问session为例，继承BaseLogWithFstr
<ul><li>实现log_parser方法（日志解析），该方法必须声明为类函数或静态函数（实例无法序列化，会引发序列化错误）
</li><li>可以通过self.context访问其它的日志对象，如self.context.parsed_rdd('MacAllActivity')
</li><li>self.context.parsed_rdd('MacAllActivity') 相当于 dpark.textFile($指定时间区间的日志列表).mergeSplit($合并分片因子).map($日志解析函数)&nbsp;
<pre class="wiki"># coding=utf-8
# author=season
import time
from logstore.base import Row, BaseLogWithFstr
from usavich.utils.deco import logsetdecorator
from usavich.utils.dtparser import parse_iso_8601


@logsetdecorator
class MacSession(BaseLogWithFstr):

    """访问session"""

    growth = 3  # mergeSplit参数，代表一天的日志合并成3个partition
    log_id = 'MacSession'  # 日志id
    log_fields = ['log_d_str', 'start_dt_str', 'close_dt_str', '_source',
                  'product', 'version', 'promotion', 'campaign',
                  'cnl', 'ads', 'pos', 'pos_type', 'url',
                  'mac', 'userid', 'userip', 'sessionid']  # 字段

    # 解析方法
    @classmethod
    def log_parser(cls, line):
        row = super(MacSession, cls).log_parser(line)
        row['start_dt'] = parse_iso_8601(row.start_dt_str)
        row['close_dt'] = parse_iso_8601(row.close_dt_str)
        row['start_d_stamp'] = time.mktime(row.start_dt.date().timetuple())
        # row['timedelta'] = int(row.timedelta)
        row['timedelta'] = (row.close_dt - row.start_dt).total_seconds()
        return row

    # 日志清洗、转换过程
    def etl(self):
        import dpark
        import datetime
        from settings import NS
        from usavich.indicator.coindicator import CoIndicator

        # 额外将前一日的session记录加入统计，解决跨天问题
        pre_started = self.started - datetime.timedelta(days=1)
        pre_ss_rdd = self.context.__class__(
            pre_started, self.ended).parsed_rdd('MacSession')
        pre_ss_flatmap_rdd = pre_ss_rdd.flatMap(
            lambda row: (Row(row, log_dt_str=row.start_dt_str),
                         Row(row, log_dt_str=row.close_dt_str)))
        raw_rdd = self.context.parsed_rdd(
            'MacAllActivity').filter(lambda x: not x.is_ins)
        union_rdd = dpark.union([raw_rdd, pre_ss_flatmap_rdd])
        uniq_key = ('_source', 'product', 'version', 'mac', 'sessionid')

        # reduce出同一session的最小和最大的时间点作为本次访问的起始时间
        stage_1 = CoIndicator(rdd=union_rdd).delta_by_flat_key(uniq_key,
                                                               'log_dt_str',
                                                               lambda x: (x, ),
                                                               numSplits=NS(1024))
        stage_2 = stage_1.map(lambda (uniq_val, ((start_dt_str, start_row), (close_dt_str, _))):
                              Row(start_row,
                                  start_dt_str=start_dt_str,
                                  close_dt_str=close_dt_str))
        self.dump_by_key(stage_2, splits=NS(20))  # 封装好的日志dump方法

</pre></li></ul></li></ul><ul><li>CoIndicator
<ul><li>为什么会有这个类？dpark本身设计模式问题，RDD类型太分裂，无法统一扩展（spark的python接口就很统一）
</li><li>封装好的一些方法
</li></ul></li></ul><blockquote>
<blockquote>
<table class="wiki">
<tbody><tr><td> 方法 </td><td> 参数 </td><td> 描述 </td><td> 例子 
</td></tr><tr><td> pv_by_flat_key </td><td> 维度，度量目标，维度拓展方法，任务splits数 </td><td> 按指定维度计数 </td><td> pv量 
</td></tr><tr><td> uv_by_flat_key </td><td> 维度，度量目标，维度拓展方法，任务splits数 </td><td> 按指定维度剔重 </td><td> uv量 
</td></tr><tr><td> max_by_flat_key </td><td> 维度，度量目标，维度拓展方法，任务splits数 </td><td> 按指定维度求最大值 </td><td> 生存周期 
</td></tr><tr><td> min_by_flat_key </td><td> 维度，度量目标，维度拓展方法，任务splits数 </td><td> 按指定维度求最小值 </td><td> 新安装设备 
</td></tr><tr><td> delta_by_flat_key </td><td> 维度，度量目标，维度拓展方法，任务splits数 </td><td> 按指定维度求区间（最大和最小值） </td><td> session时间区间计算 
</td></tr><tr><td> sum_by_flat_key </td><td> 维度，度量目标，维度拓展方法，任务splits数 </td><td> 按指定维度求和 </td><td> 成本计算 
</td></tr><tr><td style="text-align: right"> reduce_top_by_key</td><td> 维度，度量目标，维度拓展方法，任务splits数 </td><td> 按指定维度求最大或最小的那一条记录 </td><td> 活跃设备（每日设备访问记录的第一条） 
</td></tr></tbody></table>
</blockquote>
</blockquote>
</div>
        
        
      </div>
      <div class="span12">
        
    <div id="attachments" class="collapsed">
        <h3 class="foldable"><a id="no1" href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5#no1">附件</a></h3>
        <div>
          <ul>
              <li>
    <i class="icon-file"></i>
    <a href="http://10.5.17.222/main/attachment/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5/dependency.png" title="查看附件">dependency.png</a><a href="./技术分享 dpark开发实践_files/dependency.png" class="trac-rawlink" title="下载"><i class="icon-download-alt"></i></a>
       (<span title="123171 字节">120.3 KB</span>) -
      added by <em>haishanzhang</em> <a class="timeline" href="http://10.5.17.222/main/timeline?from=2014-07-29T17%3A19%3A16%2B08%3A00&precision=second" title="See timeline at 2014-7-29 下午05:19:16">13天 ago</a>.
              </li>
          </ul>
          <p>
            <span class="label label-info">下载</span>
            all attachments as: <a rel="nofollow" href="http://10.5.17.222/main/zip-attachment/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5/">.zip</a>
          </p>
        </div>
    </div>

      </div>
        <div class="span12">
          <div class="btn-toolbar">
            <form style="display:inline" method="get" action="./技术分享 dpark开发实践_files/技术分享 dpark开发实践.html" id="modifypage">
              <input type="hidden" name="action" value="edit">
              <div class="btn-group">
                    <button class="btn" type="submit" name="edit_page_button">编辑此页面</button>
              </div>
            </form>
              <form method="get" action="http://10.5.17.222/main/attachment/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5/" id="attachfile" style="display: inline-block">
  <input type="hidden" name="action" value="new">
  <div class="btn-group">
    <button type="submit" class="btn" name="attachfilebutton">
      <i class="icon-file"></i> 附加文件
    </button>
  </div>
</form>
          </div>
        </div>
    </div>
    <div id="altlinks">
      <h3>用其他格式下载:</h3>
      <ul>
        <li class="first">
          <a rel="nofollow" href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5?format=txt">纯文本</a>
        </li><li>
          <a rel="nofollow" href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5?format=slideshow">Slideshow</a>
        </li><li>
          <a rel="nofollow" href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5?format=pdfarticle">PDF Article</a>
        </li><li>
          <a rel="nofollow" href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5?format=pdfbook">PDF Book</a>
        </li><li class="last">
          <a rel="nofollow" href="http://10.5.17.222/main/wiki/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/dpark%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5?format=printhtml">Printable HTML</a>
        </li>
      </ul>
    </div>
    </div>
    <div class="container">
      <div class="row footer">
        <div class="span8">
          Powered by
          <a href="http://10.5.17.222/main/about">Apache Bloodhound
          0.5.2</a>
        </div>
        <div class="span4">
          <div class="pull-right">
            Visit Apache Bloodhound at<br><a href="https://issues.apache.org/bloodhound/">https://issues.apache.org/bloodhound/</a>
          </div>
        </div>
      </div>
    </div>
  
<script id="hiddenlpsubmitdiv" style="display: none;"></script><script>try{for(var lastpass_iter=0; lastpass_iter < document.forms.length; lastpass_iter++){ var lastpass_f = document.forms[lastpass_iter]; if(typeof(lastpass_f.lpsubmitorig2)=="undefined"){ lastpass_f.lpsubmitorig2 = lastpass_f.submit; lastpass_f.submit = function(){ var form=this; var customEvent = document.createEvent("Event"); customEvent.initEvent("lpCustomEvent", true, true); var d = document.getElementById("hiddenlpsubmitdiv"); if (d) {for(var i = 0; i < document.forms.length; i++){ if(document.forms[i]==form){ d.innerText=i; } } d.dispatchEvent(customEvent); }form.lpsubmitorig2(); } } }}catch(e){}</script></body></html>